<?php
/**
 * @file
 * Test file for the AdobeAnalytics module.
 */

class adobeAnalyticsBaseTest extends DrupalWebTestCase {
  /**
   * Implementation of setUp().
   */
  function setUp() {
    // Enable a couple modules.
    parent::setUp('adobeanalytics');
    menu_rebuild();

    // Create an admin user with all the permissions needed to run tests.
    $this->admin_user = $this->drupalCreateUser(array('administer AdobeAnalytics configuration', 'access administration pages'));
    $this->drupalLogin($this->admin_user);

    // Set some default settings.
    \Drupal::configFactory()->getEditable('adobeanalytics.settings')->set("adobeanalytics_js_file_location", 'http://www.example.com/js/s_code_remote_h.js')->save();
    \Drupal::configFactory()->getEditable('adobeanalytics.settings')->set("adobeanalytics_image_file_location", 'http://examplecom.112.2O7.net/b/ss/examplecom/1/H.20.3--NS/0')->save();
    \Drupal::configFactory()->getEditable('adobeanalytics.settings')->set("adobeanalytics_version", 'H.20.3.')->save();
  }

  function assertTrackingCode() {
    $this->assertRaw("<!-- AdobeAnalytics code version: ", 'The AdobeAnalytics code was found.');
    // @FIXME
// Could not extract the default value because it is either indeterminate, or
// not scalar. You'll need to provide a default value in
// config/install/adobeanalytics.settings.yml and config/schema/adobeanalytics.schema.yml.
$this->assertRaw(\Drupal::config('adobeanalytics.settings')->get("adobeanalytics_js_file_location"), 'The AdobeAnalytics js file was properly referenced.');
    // @FIXME
// Could not extract the default value because it is either indeterminate, or
// not scalar. You'll need to provide a default value in
// config/install/adobeanalytics.settings.yml and config/schema/adobeanalytics.schema.yml.
$this->assertRaw(\Drupal::config('adobeanalytics.settings')->get("adobeanalytics_image_file_location"), 'The AdobeAnalytics backup image was properly referenced.');
    // @FIXME
// Could not extract the default value because it is either indeterminate, or
// not scalar. You'll need to provide a default value in
// config/install/adobeanalytics.settings.yml and config/schema/adobeanalytics.schema.yml.
$this->assertRaw(\Drupal::config('adobeanalytics.settings')->get("adobeanalytics_version"), 'The correct AdobeAnalytics version was found.');
  }

  function assertNoTrackingCode() {
    $this->assertNoRaw("<!-- AdobeAnalytics code version: ", 'The AdobeAnalytics code was not found.');
    // @FIXME
// Could not extract the default value because it is either indeterminate, or
// not scalar. You'll need to provide a default value in
// config/install/adobeanalytics.settings.yml and config/schema/adobeanalytics.schema.yml.
$this->assertNoRaw(\Drupal::config('adobeanalytics.settings')->get("adobeanalytics_js_file_location"), 'The AdobeAnalytics js file was properly omitted.');
    // @FIXME
// Could not extract the default value because it is either indeterminate, or
// not scalar. You'll need to provide a default value in
// config/install/adobeanalytics.settings.yml and config/schema/adobeanalytics.schema.yml.
$this->assertNoRaw(\Drupal::config('adobeanalytics.settings')->get("adobeanalytics_image_file_location"), 'The AdobeAnalytics backup image was properly omitted.');
    // @FIXME
// Could not extract the default value because it is either indeterminate, or
// not scalar. You'll need to provide a default value in
// config/install/adobeanalytics.settings.yml and config/schema/adobeanalytics.schema.yml.
$this->assertNoRaw(\Drupal::config('adobeanalytics.settings')->get("adobeanalytics_version"), 'The AdobeAnalytics version was omitted.');
  }

  function assertAdobeAnalyticsVar($name, $value, $message = '') {
    $message = empty($message) ? 'The AdobeAnalytics variable was correctly included.' : $message;

    $edit = array(
      'adobeanalytics_variables[0][name]' => $name,
      'adobeanalytics_variables[0][value]' => $value,
    );
    $this->drupalPost('admin/config/system/adobeanalytics', $edit, t('Save configuration'));
    $this->drupalGet('node');
    $this->assertRaw($name . '="' . $value . '";', $message);
  }

  function assertInvalidAdobeAnalyticsVar($name, $value, $message = '') {
    $message = empty($message) ? 'The AdobeAnalytics variable was correctly reported as invalid.' : $message;
    $edit = array(
      'adobeanalytics_variables[0][name]' => $name,
      'adobeanalytics_variables[0][value]' => $value,
    );
    $this->drupalPost('admin/config/system/adobeanalytics', $edit, t('Save configuration'));
    $this->assertText(t('This is not a valid variable name. It must start with a letter, $ or _ and cannot contain spaces.'), $message);
  }

}

class adobeAnalyticsGeneralTest extends adobeAnalyticsBaseTest {
  /**
   * Implements getInfo().
   */
  public static function getInfo() {
    return array(
      'name' => t('AdobeAnalytics General Tests'),
      'description' => t('Tests the general functionality of the AdobeAnalytics module.'),
      'group' => t('AdobeAnalytics'),
    );
  }

  function testAdobeAnalyticsTrackingCode() {
    $this->drupalGet('<front>');
    $this->assertTrackingCode();
  }

  function testAdobeAnalyticsVariables() {
    // Test that variables with valid names are added properly.
    $valid_vars = array(
      $this->randomName(8),
      $this->randomName(8) . '7',
      '$' . $this->randomName(8),
      '_' . $this->randomName(8),
    );
    foreach ($valid_vars as $name) {
      $this->assertAdobeAnalyticsVar($name, $this->randomName(8));
    }

    // Test that invalid variable names are not allowed.
    $invalid_vars = array(
      '7' . $this->randomName(8),
      $this->randomName(8) . ' ' . $this->randomName(8),
      '#' . $this->randomName(8),
    );
    foreach ($invalid_vars as $name) {
      $this->assertInvalidAdobeAnalyticsVar($name, $this->randomName(8));
    }
  }

  function testAdobeAnalyticsRolesTracking() {
    \Drupal::configFactory()->getEditable('adobeanalytics.settings')->set('adobeanalytics_track_authenticated_user', 1)->save();
    \Drupal::configFactory()->getEditable('adobeanalytics.settings')->set('adobeanalytics_role_tracking_type', 'inclusive')->save();

    $this->drupalGet('<front>');
    $this->assertTrackingCode();

    \Drupal::configFactory()->getEditable('adobeanalytics.settings')->set('adobeanalytics_role_tracking_type', 'exclusive')->save();
    $this->drupalGet('<front>');
    $this->assertNoTrackingCode();
  }
}
